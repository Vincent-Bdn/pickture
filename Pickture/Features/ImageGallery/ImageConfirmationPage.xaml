<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Pickture.Features.ImageGallery.ImageConfirmationPage"
             Title="Confirm Selection"
             BackgroundColor="#FFFFFF">

    <Grid RowDefinitions="Auto,*,Auto" Padding="0">
        
        <!-- Header -->
        <Grid Grid.Row="0" Padding="20,15" ColumnDefinitions="*,Auto" BackgroundColor="#F5F5F5">
            <Label 
                Grid.Column="0"
                Text="Confirm Image Selection"
                FontSize="18"
                FontAttributes="Bold"
                TextColor="#333333"
                VerticalOptions="Center"/>
            
            <Button
                Grid.Column="1"
                Text="✕"
                Clicked="OnCancelClicked"
                BackgroundColor="Transparent"
                TextColor="#666666"
                FontSize="20"
                Padding="10"
                WidthRequest="40"
                HeightRequest="40"/>
        </Grid>

        <!-- Main Content Area: Left (Image) + Right (Controls) -->
        <Grid Grid.Row="1" ColumnDefinitions="*,320" ColumnSpacing="0" Padding="0">
            
            <!-- Left Side: Image with Grid Overlay -->
            <Grid Grid.Column="0" Padding="20" BackgroundColor="#FFFFFF">
                <Frame 
                    CornerRadius="8" 
                    HasShadow="True" 
                    Padding="0" 
                    Margin="0"
                    BorderColor="#E0E0E0">
                    
                    <Grid BackgroundColor="#E8E8E8">
                        <!-- Main Image -->
                        <Image 
                            x:Name="PreviewImage"
                            Aspect="AspectFit"
                            BackgroundColor="#E8E8E8"
                            Source="{Binding DisplayedImage}"
                            Rotation="{Binding FinalRotation}"/>
                        
                        <!-- Grid Overlay using GraphicsView -->
                        <GraphicsView 
                            x:Name="GridOverlayView" 
                            Drawable="{Binding GridDrawable}"
                            IsEnabled="False"/>
                        
                        <!-- Semi-transparent Overlay + Loading Spinner -->
                        <BoxView 
                            BackgroundColor="#F5F5F5"
                            Opacity="0.7"
                            IsVisible="{Binding IsLoadingSelectedVisualEffect}"/>
                        
                        <ActivityIndicator 
                            IsRunning="{Binding IsLoadingSelectedVisualEffect}"
                            IsVisible="{Binding IsLoadingSelectedVisualEffect}"
                            Color="#007AFF"
                            Scale="2"
                            HorizontalOptions="Center"
                            VerticalOptions="Center"/>
                    </Grid>
                </Frame>
            </Grid>

            <!-- Right Side: Controls Panel with ScrollView -->
            <ScrollView Grid.Column="1" BackgroundColor="#F5F5F5">
                <StackLayout Padding="15" Spacing="15">
                
                <!-- Visual Effects Section -->
                <Label 
                    Text="Visual Effects"
                    FontSize="14"
                    FontAttributes="Bold"
                    TextColor="#333333"/>
                
                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                    <Button
                        Grid.Row="0"
                        Text="White Balance (V)"
                        Clicked="OnVisualEffectClicked"
                        CommandParameter="WhiteBalanceValue"
                        BackgroundColor="{Binding SelectedVisualEffect, Converter={StaticResource VisualEffectButtonColorConverter}, ConverterParameter=WhiteBalanceValue}"
                        TextColor="{Binding SelectedVisualEffect, Converter={StaticResource VisualEffectTextColorConverter}, ConverterParameter=WhiteBalanceValue}"
                        Padding="12,8"
                        FontSize="12"/>
                    
                    <Button
                        Grid.Row="1"
                        Text="White Balance (RGB)"
                        Clicked="OnVisualEffectClicked"
                        CommandParameter="WhiteBalanceRGB"
                        BackgroundColor="{Binding SelectedVisualEffect, Converter={StaticResource VisualEffectButtonColorConverter}, ConverterParameter=WhiteBalanceRGB}"
                        TextColor="{Binding SelectedVisualEffect, Converter={StaticResource VisualEffectTextColorConverter}, ConverterParameter=WhiteBalanceRGB}"
                        Padding="12,8"
                        FontSize="12"/>
                    
                    <Button
                        Grid.Row="2"
                        Text="Custom Histogram"
                        Clicked="OnVisualEffectClicked"
                        CommandParameter="Custom"
                        BackgroundColor="{Binding SelectedVisualEffect, Converter={StaticResource VisualEffectButtonColorConverter}, ConverterParameter=Custom}"
                        TextColor="{Binding SelectedVisualEffect, Converter={StaticResource VisualEffectTextColorConverter}, ConverterParameter=Custom}"
                        Padding="12,8"
                        FontSize="12"/>
                </Grid>

                <!-- Custom Histogram Controls Box (shown when Custom is selected) -->
                <Frame 
                    IsVisible="{Binding SelectedVisualEffect, Converter={StaticResource CustomEffectVisibleConverter}}"
                    CornerRadius="8"
                    HasShadow="True"
                    BorderColor="#E0E0E0"
                    Padding="12"
                    Margin="0,5,0,0"
                    BackgroundColor="#FFFFFF">
                    
                    <StackLayout Spacing="10">
                    
                    <!-- Histogram Chart -->
                    <Label 
                        Text="Histogram"
                        FontSize="12"
                        FontAttributes="Bold"
                        TextColor="#333333"/>
                    
                    <Frame 
                        CornerRadius="4" 
                        HasShadow="False" 
                        Padding="0" 
                        Margin="0"
                        BorderColor="#E0E0E0"
                        HeightRequest="100">
                        <Grid x:Name="HistogramContainer">
                            <GraphicsView 
                                x:Name="HistogramView"
                                Drawable="{Binding HistogramDrawable}"
                                BackgroundColor="#FFFFFF"
                                IsEnabled="False"/>
                            
                            <!-- Loading Spinner for Histogram -->
                            <BoxView 
                                BackgroundColor="#FFFFFF"
                                Opacity="0.7"
                                IsVisible="{Binding IsLoadingHistogram}"/>
                            
                            <ActivityIndicator 
                                IsRunning="{Binding IsLoadingHistogram}"
                                IsVisible="{Binding IsLoadingHistogram}"
                                Color="#007AFF"
                                Scale="1.5"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"/>
                        </Grid>
                    </Frame>

                    <!-- Low Value Clamping -->
                    <Grid ColumnDefinitions="60,*" ColumnSpacing="8" Margin="0,5,0,0">
                        <Label 
                            Grid.Column="0"
                            Text="Low:"
                            FontSize="11"
                            FontAttributes="Bold"
                            TextColor="#333333"
                            VerticalOptions="Center"/>
                        
                        <Entry 
                            x:Name="LowClampEntry"
                            Grid.Column="1"
                            Text="{Binding LowClampValue, StringFormat='{0:F0}', Mode=TwoWay, UpdateSourceEventName=TextChanged}"
                            Keyboard="Numeric"
                            BackgroundColor="#F5F5F5"
                            TextColor="#333333"
                            PlaceholderColor="#999999"
                            Placeholder="0-254"
                            FontSize="11"/>
                    </Grid>

                    <!-- High Value Clamping -->
                    <Grid ColumnDefinitions="60,*" ColumnSpacing="8">
                        <Label 
                            Grid.Column="0"
                            Text="High:"
                            FontSize="11"
                            FontAttributes="Bold"
                            TextColor="#333333"
                            VerticalOptions="Center"/>
                        
                        <Entry 
                            x:Name="HighClampEntry"
                            Grid.Column="1"
                            Text="{Binding HighClampValue, StringFormat='{0:F0}', Mode=TwoWay, UpdateSourceEventName=TextChanged}"
                            Keyboard="Numeric"
                            BackgroundColor="#F5F5F5"
                            TextColor="#333333"
                            PlaceholderColor="#999999"
                            Placeholder="1-255"
                            FontSize="11"/>
                    </Grid>

                    <!-- Gamma Input -->
                    <Grid ColumnDefinitions="60,*" ColumnSpacing="8">
                        <Label 
                            Grid.Column="0"
                            Text="Gamma:"
                            FontSize="11"
                            FontAttributes="Bold"
                            TextColor="#333333"
                            VerticalOptions="Center"/>
                        
                        <Entry 
                            x:Name="GammaEntry"
                            Grid.Column="1"
                            Text="{Binding GammaValue, StringFormat='{0:F2}', Mode=TwoWay, UpdateSourceEventName=TextChanged}"
                            Keyboard="Numeric"
                            BackgroundColor="#F5F5F5"
                            TextColor="#333333"
                            PlaceholderColor="#999999"
                            Placeholder="0.50 - 2.50"
                            FontSize="11"/>
                    </Grid>

                    <!-- Apply Button with Spinner -->
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10" Margin="0,10,0,0">
                        <Button
                            Grid.Column="0"
                            Text="Apply"
                            Clicked="OnApplyCustomEffectClicked"
                            BackgroundColor="#007AFF"
                            TextColor="White"
                            Padding="10,8"
                            FontSize="11"
                            IsEnabled="{Binding IsProcessingCustomEffect, Converter={StaticResource InvertedBoolConverter}}"/>
                        
                        <ActivityIndicator 
                            Grid.Column="1"
                            IsRunning="{Binding IsProcessingCustomEffect}"
                            IsVisible="{Binding IsProcessingCustomEffect}"
                            Color="#007AFF"
                            Scale="1.2"
                            VerticalOptions="Center"/>
                    </Grid>

                    </StackLayout>
                </Frame>
                
                <!-- 90° Rotation Buttons -->
                <Label 
                    Text="Rotation"
                    FontSize="14"
                    FontAttributes="Bold"
                    TextColor="#333333"
                    Margin="0,10,0,0"/>
                
                <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                    <Button
                        Grid.Column="0"
                        Text="↻ -90°"
                        Clicked="OnRotateLeft90Clicked"
                        BackgroundColor="#E0E0E0"
                        TextColor="#333333"
                        Padding="10,8"
                        FontSize="12"/>
                    
                    <Button
                        Grid.Column="1"
                        Text="90° ↺"
                        Clicked="OnRotateRight90Clicked"
                        BackgroundColor="#E0E0E0"
                        TextColor="#333333"
                        Padding="10,8"
                        FontSize="12"/>
                </Grid>

                <!-- Fine Rotation Slider -->
                <!-- <Label 
                    Text="Fine Tune"
                    FontSize="14"
                    FontAttributes="Bold"
                    TextColor="#333333"
                    Margin="0,10,0,0"/> -->
                
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Label 
                        Grid.Column="0"
                        Text="{Binding RotationAngle, StringFormat='Angle: {0:F1}°'}"
                        FontSize="12"
                        TextColor="#666666"/>
                    
                    <Button
                        Grid.Column="1"
                        Text="Reset"
                        Clicked="OnResetRotationClicked"
                        BackgroundColor="#FF9500"
                        TextColor="White"
                        Padding="8,4"
                        FontSize="11"
                        WidthRequest="60"/>
                </Grid>
                
                <Slider 
                    Minimum="-45"
                    Maximum="45"
                    Value="{Binding RotationAngle}"
                    BackgroundColor="Transparent"
                    Margin="0,5,0,0"/>
                
                <!-- Spacer -->
                <!-- <BoxView HeightRequest="5"/> -->
                
                </StackLayout>
            </ScrollView>

        </Grid>

        <!-- Button Area -->
        <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10" Padding="20" BackgroundColor="#F5F5F5">
            <BoxView Grid.Column="0" BackgroundColor="Transparent"/>
            
            <Button
                Grid.Column="1"
                Text="Cancel"
                Clicked="OnCancelClicked"
                BackgroundColor="#E0E0E0"
                TextColor="#333333"
                Padding="20,12"
                FontSize="14"
                WidthRequest="120"/>
            
            <Button
                Grid.Column="2"
                Text="Confirm"
                Clicked="OnConfirmClicked"
                BackgroundColor="#007AFF"
                TextColor="White"
                Padding="20,12"
                FontSize="14"
                WidthRequest="120"/>
        </Grid>

    </Grid>

</ContentPage>

